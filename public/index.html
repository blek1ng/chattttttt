<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  <title>Sala de Bate-Papo</title>
</head>

<body>
  <div class="video">
    <div id="player"></div>
    <div class="envio"> 
    <input id="ytUrl" type="text" placeholder="Cole o link do YouTube"/>
    <button onclick="loadVideo()" style="width: 20%; height: 40px;">Carregar</button>
    </div>
  </div>

  <div id="chat"></div>
  <div class="envio">
      <input type="text" id="msg" placeholder="Digite sua mensagem" />
      <button onclick="sendMessage()">
        <i id="btn-enviar" class="fa-solid fa-paper-plane"></i>
      </button>
  </div>



  <script>
    const socket = new WebSocket("wss://chattttttt-alnz.onrender.com");
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    let player;

    // ID único do usuário
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = Math.random().toString(36).substring(2, 10);
      localStorage.setItem("userId", userId);
    }

    // Salvar e carregar mensagens do chat
    function carregarMensagens() {
      const mensagens = JSON.parse(localStorage.getItem("chatMensagens") || "[]");
      mensagens.forEach(({ texto, tipo }) => {
        adicionarMensagemNaTela(texto, tipo);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    function salvarMensagem(texto, tipo) {
      const mensagens = JSON.parse(localStorage.getItem("chatMensagens") || "[]");
      mensagens.push({ texto, tipo });
      localStorage.setItem("chatMensagens", JSON.stringify(mensagens));
    }

    function adicionarMensagemNaTela(texto, tipo) {
      const p = document.createElement("p");
      p.classList.add("msg", tipo); // 'enviada' ou 'recebida'
      p.textContent = texto;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    // Receber mensagens (chat ou vídeo)
    socket.onmessage = function (event) {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "chat") {
          const tipo = data.userId === userId ? "enviada" : "recebida";
          salvarMensagem(data.mensagem, tipo);
          adicionarMensagemNaTela(data.mensagem, tipo);
        } else if (data.type === "video") {
          if (!player) return;
          if (data.action === "load") {
            const id = extractId(data.url);
            player.loadVideoById(id);
          } else if (data.action === "play") {
            player.playVideo();
          } else if (data.action === "pause") {
            player.pauseVideo();
          } else if (data.action === "seek") {
            player.seekTo(data.time, true);
          }
        }
      } catch (e) {
        // Se não for JSON válido
        adicionarMensagemNaTela(event.data, "recebida");
      }
    };

    function sendMessage() {
      const mensagem = input.value.trim();
      if (mensagem !== "") {
        socket.send(JSON.stringify({
          type: "chat",
          userId,
          mensagem
        }));
        input.value = "";
      }
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    window.onload = carregarMensagens;

    // Torna a função global para o YouTube chamar corretamente
    window.onYouTubeIframeAPIReady = function () {
      player = new YT.Player('player', {
        videoId: '',
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    };

    function extractId(url) {
      try {
        const urlObj = new URL(url);
        if (urlObj.hostname === 'youtu.be') {
          return urlObj.pathname.slice(1);
        } else if (urlObj.hostname.includes('youtube.com')) {
          return urlObj.searchParams.get('v');
        }
      } catch {
        return null;
      }
      return null;
    }

    function loadVideo() {
      const url = document.getElementById('ytUrl').value;
      const id = extractId(url);
      if (id && player) {
        player.loadVideoById(id);
        socket.send(JSON.stringify({ type: 'video', action: 'load', url }));
      }
    }

    function onPlayerStateChange(event) {
      if (!player) return;
      if (event.data === YT.PlayerState.PLAYING) {
        socket.send(JSON.stringify({ type: 'video', action: 'play' }));
      } else if (event.data === YT.PlayerState.PAUSED) {
        socket.send(JSON.stringify({ type: 'video', action: 'pause' }));
      }
    }

    // Enviar tempo atual do vídeo a cada 5 segundos
    let lastSentTime = 0;

    setInterval(() => {
      if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
        const currentTime = player.getCurrentTime();
        if (Math.abs(currentTime - lastSentTime) > 1) { // só envia se dif > 1s
          socket.send(JSON.stringify({ type: 'video', action: 'seek', time: currentTime }));
          lastSentTime = currentTime;
        }
      }
    }, 60000);

  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
</body>

</html>